

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Price Tracker Ruleset &mdash; Fathom 3.7.3 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Smoot Shopping Ruleset" href="smoot_shopping.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Fathom
          

          
          </a>

          
            
            
              <div class="version">
                3.7.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../samples.html">Collecting Samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rules.html">Writing Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../integrating.html">Integrating</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintaining.html">Maintaining</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zoo.html">Ruleset Zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../clustering.html">Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fnodes.html">Fnodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ruleset.html">Rules and Rulesets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities.html">Utility Functions</a></li>
</ul>
<p class="caption"><span class="caption-text">Command Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../commands/extract.html">fathom extract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/fox.html">fathom fox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/histogram.html">fathom histogram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/label.html">fathom label</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/list.html">fathom list</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/pick.html">fathom pick</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/serve.html">fathom serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/test.html">fathom test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/train.html">fathom train</a></li>
</ul>
<p class="caption"><span class="caption-text">Back Matter</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../example.html">Example Ruleset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Version History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Fathom</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Price Tracker Ruleset</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/zoo/price_tracker.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="price-tracker-ruleset">
<h1>Price Tracker Ruleset<a class="headerlink" href="#price-tracker-ruleset" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-js notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<span class="cm"> * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<span class="cm"> * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

<span class="kr">import</span> <span class="p">{</span><span class="nx">dom</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">rule</span><span class="p">,</span> <span class="nx">ruleset</span><span class="p">,</span> <span class="nx">score</span><span class="p">,</span> <span class="nx">type</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;fathom-web&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">ancestors</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;fathom-web/utilsForFrontend&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">euclidean</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;fathom-web/clusters&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">TOP_BUFFER</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
<span class="c1">// From: https://github.com/mozilla/fathom-trainees/blob/master/src/trainees.js</span>

<span class="cm">/**</span>
<span class="cm"> * Creates Fathom ruleset instances, and holds individual rule methods for</span>
<span class="cm"> * easier testing.</span>
<span class="cm"> */</span>
<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">RulesetFactory</span> <span class="p">{</span>
  <span class="cm">/** Scores fnode in direct proportion to its size */</span>
  <span class="nx">isBig</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">domRect</span> <span class="o">=</span> <span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">area</span> <span class="o">=</span> <span class="nx">domRect</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">domRect</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>

    <span class="c1">// Assume no product images as small as 80px^2. No further bonus over</span>
    <span class="c1">// 1000^2. For one thing, that&#39;s getting into background image territory</span>
    <span class="c1">// (though we should have distinct penalties for that sort of thing if we</span>
    <span class="c1">// care). More importantly, clamp the upper bound of the score so we don&#39;t</span>
    <span class="c1">// overcome other bonuses and penalties.</span>
    <span class="k">return</span> <span class="nx">linearScale</span><span class="p">(</span><span class="nx">area</span><span class="p">,</span> <span class="mi">80</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">**</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/** Return whether the computed font size of an element is big. */</span>
  <span class="nx">fontIsBig</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">size</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">).</span><span class="nx">fontSize</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">linearScale</span><span class="p">(</span><span class="nx">size</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/** Scores fnode with a &#39;$&#39; in its innerText */</span>
  <span class="nx">hasDollarSign</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">innerText</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Return whether some substring is within a given string, case</span>
<span class="cm">   * insensitively.</span>
<span class="cm">   */</span>
  <span class="nx">caselessIncludes</span><span class="p">(</span><span class="nx">haystack</span><span class="p">,</span> <span class="nx">needle</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">haystack</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="nx">needle</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Return a weighted confidence of whether a substring is within a given</span>
<span class="cm">   * string, case insensitively.</span>
<span class="cm">   */</span>
  <span class="nx">stringIncludes</span><span class="p">(</span><span class="nx">haystack</span><span class="p">,</span> <span class="nx">needle</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">caselessIncludes</span><span class="p">(</span><span class="nx">haystack</span><span class="p">,</span> <span class="nx">needle</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Punish elements with &quot;background&quot; in their ID. Do nothing to those without.</span>
<span class="cm">   */</span>
  <span class="nx">hasBackgroundInID</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">caselessIncludes</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** Scores fnode with &#39;price&#39; in its id */</span>
  <span class="nx">hasPriceInID</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stringIncludes</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">hasPriceInParentID</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stringIncludes</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/** Scores fnode with &#39;price&#39; in its class name */</span>
  <span class="nx">hasPriceInClassName</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stringIncludes</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">className</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/** Scores fnode with &#39;price&#39; in its parent&#39;s class name */</span>
  <span class="nx">hasPriceInParentClassName</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stringIncludes</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">className</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/** Scores fnode by its vertical location relative to the fold */</span>
  <span class="nx">isAboveTheFold</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">viewportHeight</span> <span class="o">=</span> <span class="mi">950</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">imageTop</span> <span class="o">=</span> <span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">().</span><span class="nx">top</span><span class="p">;</span>

    <span class="c1">// Stop giving additional bonus for anything closer than 200px to the top</span>
    <span class="c1">// of the viewport. Those are probably usually headers.</span>
    <span class="k">return</span> <span class="nx">linearScale</span><span class="p">(</span><span class="nx">imageTop</span><span class="p">,</span> <span class="nx">viewportHeight</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Return whether the centerpoint of the element is near that of the highest-</span>
<span class="cm">   * scoring image.</span>
<span class="cm">   */</span>
  <span class="nx">isNearImage</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">imageFnode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHighestScoringImage</span><span class="p">(</span><span class="nx">fnode</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">linearScale</span><span class="p">(</span><span class="nx">euclidean</span><span class="p">(</span><span class="nx">fnode</span><span class="p">,</span> <span class="nx">imageFnode</span><span class="p">),</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Return whether the potential title is near the top or bottom of the</span>
<span class="cm">   * highest-scoring image.</span>
<span class="cm">   *</span>
<span class="cm">   * This is a makeshift ORing of 2 signals: a &quot;near the top&quot; and a &quot;near the</span>
<span class="cm">   * bottom&quot; one.</span>
<span class="cm">   */</span>
  <span class="nx">isNearImageTopOrBottom</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">imageElement</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHighestScoringImage</span><span class="p">(</span><span class="nx">fnode</span><span class="p">).</span><span class="nx">element</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">imageRect</span> <span class="o">=</span> <span class="nx">imageElement</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">nodeRect</span> <span class="o">=</span> <span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>

    <span class="c1">// Should cover title above image and title in a column next to image.</span>
    <span class="c1">// Could also consider using the y-axis midpoint of title.</span>
    <span class="kr">const</span> <span class="nx">topDistance</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">imageRect</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">nodeRect</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>

    <span class="c1">// Test nodeRect.top. They&#39;re probably not side by side with the title at</span>
    <span class="c1">// the bottom. Rather, title will be below image.</span>
    <span class="kr">const</span> <span class="nx">bottomDistance</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">imageRect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">nodeRect</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">shortestDistance</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">topDistance</span><span class="p">,</span> <span class="nx">bottomDistance</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">linearScale</span><span class="p">(</span><span class="nx">shortestDistance</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Return whether the fnode&#39;s innertext contains a dollars-and-cents number.</span>
<span class="cm">   */</span>
  <span class="nx">hasPriceishPattern</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">innerText</span><span class="p">;</span>
    <span class="cm">/**</span>
<span class="cm">     * With an optional &#39;$&#39; that doesn&#39;t necessarily have to be at the beginning</span>
<span class="cm">     * of the string (ex: &#39;US $5.00&#39; on Ebay), matches any number of digits before</span>
<span class="cm">     * a decimal point and exactly two after.</span>
<span class="cm">     */</span>
    <span class="kr">const</span> <span class="nx">regExp</span> <span class="o">=</span> <span class="sr">/\$?\d+\.\d{2}(?![0-9])/</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">regExp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/** Checks to see if a &#39;price&#39; fnode is eligible for scoring */</span>
  <span class="nx">isEligiblePrice</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">isVisible</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span>
      <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasDifferentInnerTextThanChildren</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span>
      <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isNearbyImageYAxisPrice</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/** Checks to see if a &#39;title&#39; fnode is eligible for scoring */</span>
  <span class="nx">isEligibleTitle</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">isVisible</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span>
      <span class="c1">// Don&#39;t use hasDifferentInnerTextThanChildren, because &lt;h1&gt; tags</span>
      <span class="c1">// for Amazon and Walmart have &lt;span&gt; and &lt;div&gt; element children,</span>
      <span class="c1">// respectively, with the same innerText.</span>
      <span class="c1">//</span>
      <span class="c1">// Don&#39;t use isNearbyImageYAxisTitle here, as unlike for price, there</span>
      <span class="c1">// is a strong correlation for vertical proximity to image, so we want</span>
      <span class="c1">// to score it proportionally rather than have a hard cut-off.</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Checks if fnode has different innerText compared to any of its children</span>
<span class="cm">   */</span>
  <span class="nx">hasDifferentInnerTextThanChildren</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">descendant</span> <span class="k">of</span> <span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">descendant</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">===</span> <span class="nx">element</span><span class="p">.</span><span class="nx">innerText</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Checks if fnode is nearby the top scoring image element in the y-axis</span>
<span class="cm">   * Unlike for &#39;title&#39;, &#39;price&#39; elements had worse accuracy when scored</span>
<span class="cm">   * in proportion to y-axis proximity to the image.</span>
<span class="cm">   */</span>
  <span class="nx">isNearbyImageYAxisPrice</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">DOMRect</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">imageElement</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHighestScoringImage</span><span class="p">(</span><span class="nx">fnode</span><span class="p">).</span><span class="nx">element</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">imageDOMRect</span> <span class="o">=</span> <span class="nx">imageElement</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">DOMRect</span><span class="p">.</span><span class="nx">top</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nx">imageDOMRect</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">TOP_BUFFER</span><span class="p">)</span>
      <span class="o">&amp;&amp;</span> <span class="nx">DOMRect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">&lt;=</span> <span class="nx">imageDOMRect</span><span class="p">.</span><span class="nx">bottom</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">isVisible</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">ancestor</span> <span class="k">of</span> <span class="nx">ancestors</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">ancestor</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">isElementHidden</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">===</span> <span class="s1">&#39;hidden&#39;</span>
        <span class="o">||</span> <span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">===</span> <span class="s1">&#39;none&#39;</span>
        <span class="o">||</span> <span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span>
        <span class="o">||</span> <span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span>
        <span class="o">||</span> <span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span>
      <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isElementHidden</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">hasBackgroundImage</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">bgImage</span> <span class="o">=</span> <span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">)[</span><span class="s1">&#39;background-image&#39;</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">bgImage</span> <span class="o">&amp;&amp;</span> <span class="nx">bgImage</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;url(&quot;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">bgImage</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;&quot;)&#39;</span><span class="p">);</span>
    <span class="c1">// The app doesn&#39;t yet know how to deal with non-url() types of background</span>
    <span class="c1">// images.</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Return the aspect ratio of a fnode&#39;s client rect, with horizontal and</span>
<span class="cm">   * vertical rearranged so it&#39;s always &gt;=1.</span>
<span class="cm">   */</span>
  <span class="nx">aspectRatio</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">width</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">Infinity</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/** Give a bonus for elements that have a non-extreme aspect ratio. */</span>
  <span class="nx">hasSquareAspectRatio</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">linearScale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">aspectRatio</span><span class="p">(</span><span class="nx">fnode</span><span class="p">.</span><span class="nx">element</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">  * Using coefficients passed into the constructor method, returns a weighted</span>
<span class="cm">  * ruleset used to score elements in an HTML document.</span>
<span class="cm">  */</span>
  <span class="nx">makeRuleset</span><span class="p">(</span><span class="nx">coeffs</span><span class="p">,</span> <span class="nx">biases</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ruleset</span><span class="p">([</span>
      <span class="cm">/**</span>
<span class="cm">       * Image rules</span>
<span class="cm">       */</span>
      <span class="c1">// consider all visible img elements</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">dom</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">when</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isVisible</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="nx">type</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)),</span>
      <span class="c1">// and divs, which sometimes have CSS background-images</span>
      <span class="c1">// TODO: Consider a bonus for &lt;img&gt; tags.</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">dom</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">when</span><span class="p">(</span><span class="nx">fnode</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isVisible</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasBackgroundImage</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)),</span> <span class="nx">type</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)),</span>
      <span class="c1">// better score the closer the element is to the top of the page</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isAboveTheFold</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;isAboveTheFoldImage&#39;</span><span class="p">}),</span>
      <span class="c1">// better score for larger images</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBig</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;isBig&#39;</span><span class="p">}),</span>
      <span class="c1">// bonus for non-extreme aspect ratios, to filter out banners or nav elements</span>
      <span class="c1">// TODO: Meant to make this a penalty, but it turns out to work as is.</span>
      <span class="c1">// Try as a penalty.</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasSquareAspectRatio</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;hasSquareAspectRatio&#39;</span><span class="p">}),</span>
      <span class="c1">// no background images, even ones that have reasonable aspect ratios</span>
      <span class="c1">// TODO: If necessary, also look at parents. I&#39;ve seen them say</span>
      <span class="c1">// &quot;background&quot; in their IDs as well.</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasBackgroundInID</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;hasBackgroundInID&#39;</span><span class="p">}),</span>
      <span class="c1">// return image element(s) with max score</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">).</span><span class="nx">max</span><span class="p">(),</span> <span class="nx">out</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)),</span>

      <span class="cm">/**</span>
<span class="cm">       * Title rules</span>
<span class="cm">       */</span>
      <span class="c1">// consider all eligible h1 elements</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">dom</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">).</span><span class="nx">when</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isEligibleTitle</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="nx">type</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)),</span>
      <span class="c1">// better score based on y-axis proximity to max scoring image element</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isNearImageTopOrBottom</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;isNearImageTopOrBottom&#39;</span><span class="p">}),</span>
      <span class="c1">// return title element(s) with max score</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">).</span><span class="nx">max</span><span class="p">(),</span> <span class="nx">out</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)),</span>

      <span class="cm">/**</span>
<span class="cm">       * Price rules</span>
<span class="cm">       */</span>
      <span class="c1">// 72% by itself, at [4, 4, 4, 4...]!:</span>
      <span class="c1">// consider all eligible span and h2 elements</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">dom</span><span class="p">(</span><span class="s1">&#39;span, h2&#39;</span><span class="p">).</span><span class="nx">when</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isEligiblePrice</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)),</span>
      <span class="c1">// check if the element has a &#39;$&#39; in its innerText</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasDollarSign</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;hasDollarSign&#39;</span><span class="p">}),</span>
      <span class="c1">// better score the closer the element is to the top of the page</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isAboveTheFold</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;isAboveTheFoldPrice&#39;</span><span class="p">}),</span>
      <span class="c1">// check if the id has &quot;price&quot; in it</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasPriceInID</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;hasPriceInID&#39;</span><span class="p">}),</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasPriceInParentID</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;hasPriceInParentID&#39;</span><span class="p">}),</span>
      <span class="c1">// check if any class names have &quot;price&quot; in them</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasPriceInClassName</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;hasPriceInClassName&#39;</span><span class="p">}),</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasPriceInParentClassName</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;hasPriceInParentClassName&#39;</span><span class="p">}),</span>
      <span class="c1">// better score for larger font size</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fontIsBig</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;fontIsBig&#39;</span><span class="p">}),</span>
      <span class="c1">// better score based on x-axis proximity to max scoring image element</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isNearImage</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;isNearImage&#39;</span><span class="p">}),</span>
      <span class="c1">// check if innerText has a price pattern</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span> <span class="nx">score</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasPriceishPattern</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;hasPriceishPattern&#39;</span><span class="p">}),</span>
      <span class="c1">// return price element(s) with max score</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">).</span><span class="nx">max</span><span class="p">(),</span> <span class="nx">out</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)),</span>
    <span class="p">],</span>
    <span class="nx">coeffs</span><span class="p">,</span>
    <span class="nx">biases</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">getHighestScoringImage</span><span class="p">(</span><span class="nx">fnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fnode</span><span class="p">.</span><span class="nx">_ruleset</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// eslint-disable-line no-underscore-dangle</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Scale a number to the range [0, 1].</span>
<span class="cm"> *</span>
<span class="cm"> * For a rising line, the result is 0 until the input reaches</span>
<span class="cm"> * zeroAt, then increases linearly until oneAt, at which it becomes 1. To</span>
<span class="cm"> * make a falling line, where the result is 1 to the left and 0</span>
<span class="cm"> * to the right, use a zeroAt greater than oneAt.</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">linearScale</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="nx">zeroAt</span><span class="p">,</span> <span class="nx">oneAt</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">isRising</span> <span class="o">=</span> <span class="nx">zeroAt</span> <span class="o">&lt;</span> <span class="nx">oneAt</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isRising</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">number</span> <span class="o">&lt;=</span> <span class="nx">zeroAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">number</span> <span class="o">&gt;=</span> <span class="nx">oneAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">number</span> <span class="o">&gt;=</span> <span class="nx">zeroAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">number</span> <span class="o">&lt;=</span> <span class="nx">oneAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">slope</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">oneAt</span> <span class="o">-</span> <span class="nx">zeroAt</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">slope</span> <span class="o">*</span> <span class="p">(</span><span class="nx">number</span> <span class="o">-</span> <span class="nx">zeroAt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="smoot_shopping.html" class="btn btn-neutral float-left" title="Smoot Shopping Ruleset" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017-2019, Mozilla Foundation

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>